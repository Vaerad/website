<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparateur Excel Automatique</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS pour lire et écrire des fichiers Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-800">

    <!-- Header -->
    <header class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <h1 class="text-2xl font-bold flex items-center gap-2">
                <i class="fa-solid fa-file-excel"></i>
                Comparateur Excel Automatique
            </h1>
            <p class="text-blue-100 text-sm mt-1">Fusionne "TOTAL GERE" et "MACHINE SANS RC" via le numéro de série caché.</p>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 max-w-4xl">

        <!-- Status Messages -->
        <div id="statusMessage" class="hidden mb-6 p-4 rounded-lg"></div>

        <!-- Upload Section -->
        <div class="grid md:grid-cols-2 gap-6 mb-8">
            
            <!-- Carte Fichier 1 -->
            <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200 hover:border-blue-400 transition-colors">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="font-bold text-lg text-slate-700">1. Fichier de Référence</h2>
                    <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">TOTAL GERE</span>
                </div>
                <p class="text-sm text-slate-500 mb-4">Contient les compteurs (Mono/Couleur) et les modèles.</p>
                
                <label class="block w-full cursor-pointer">
                    <input type="file" id="fileRef" accept=".xlsx, .xls, .csv" class="hidden" onchange="handleFile(this, 'refStatus')">
                    <div class="w-full border-2 border-dashed border-slate-300 rounded-lg p-4 text-center hover:bg-slate-50 transition">
                        <i class="fa-solid fa-upload text-2xl text-slate-400 mb-2"></i>
                        <p class="text-sm font-medium text-slate-600">Choisir le fichier</p>
                        <p id="refStatus" class="text-xs text-slate-400 mt-1">Aucun fichier sélectionné</p>
                    </div>
                </label>
            </div>

            <!-- Carte Fichier 2 -->
            <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200 hover:border-orange-400 transition-colors">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="font-bold text-lg text-slate-700">2. Fichier à Compléter</h2>
                    <span class="bg-orange-100 text-orange-800 text-xs px-2 py-1 rounded-full">MACHINE SANS RC</span>
                </div>
                <p class="text-sm text-slate-500 mb-4">Contient les commentaires avec les numéros de série cachés.</p>
                
                <label class="block w-full cursor-pointer">
                    <input type="file" id="fileTarget" accept=".xlsx, .xls, .csv" class="hidden" onchange="handleFile(this, 'targetStatus')">
                    <div class="w-full border-2 border-dashed border-slate-300 rounded-lg p-4 text-center hover:bg-slate-50 transition">
                        <i class="fa-solid fa-upload text-2xl text-slate-400 mb-2"></i>
                        <p class="text-sm font-medium text-slate-600">Choisir le fichier</p>
                        <p id="targetStatus" class="text-xs text-slate-400 mt-1">Aucun fichier sélectionné</p>
                    </div>
                </label>
            </div>
        </div>

        <!-- Action Button -->
        <div class="text-center mb-8">
            <button onclick="processFiles()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition hover:-translate-y-1 active:scale-95 flex items-center gap-2 mx-auto disabled:opacity-50 disabled:cursor-not-allowed" id="processBtn">
                <i class="fa-solid fa-gears"></i>
                Lancer le traitement
            </button>
        </div>

        <!-- Results Section (Hidden initially) -->
        <div id="resultSection" class="hidden bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="p-4 bg-green-50 border-b border-green-100 flex justify-between items-center flex-wrap gap-4">
                <div>
                    <h3 class="font-bold text-green-800">Traitement terminé !</h3>
                    <p class="text-sm text-green-600" id="resultCount">0 lignes traitées</p>
                    <div id="resultDetails" class="text-xs text-slate-400 mt-1 italic flex gap-4">
                        <!-- Details added by JS -->
                    </div>
                </div>
                <button onclick="downloadExcel()" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg shadow text-sm font-bold flex items-center gap-2">
                    <i class="fa-solid fa-download"></i>
                    Télécharger le fichier Excel
                </button>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                        <tr>
                            <th class="px-6 py-3">Client</th>
                            <th class="px-6 py-3 text-blue-600">Série (Extraite)</th>
                            <th class="px-6 py-3 text-green-600">Modèle (Trouvé)</th>
                            <th class="px-6 py-3">Total Mono</th>
                            <th class="px-6 py-3">Total Couleur</th>
                        </tr>
                    </thead>
                    <tbody id="previewBody">
                        <!-- Rows will be inserted here -->
                    </tbody>
                </table>
            </div>
            <div class="p-3 text-center text-xs text-slate-400 bg-slate-50">
                Aperçu des 5 premières lignes (filtrées)
            </div>
        </div>

    </main>

    <script>
        let dataRef = null;    // Données TOTAL GERE
        let dataTarget = null; // Données MACHINE SANS RC
        let finalData = null;  // Résultat

        // Fonction intelligente pour trouver la bonne feuille et la bonne ligne d'en-tête
        function findBestData(workbook, keywords) {
            // On parcourt toutes les feuilles
            for (const sheetName of workbook.SheetNames) {
                const sheet = workbook.Sheets[sheetName];
                const rows = XLSX.utils.sheet_to_json(sheet, {header: 1, defval: ""});
                
                // On cherche dans les 20 premières lignes
                for (let i = 0; i < Math.min(rows.length, 20); i++) {
                    if (!rows[i]) continue;
                    
                    // On convertit la ligne en texte minuscule pour chercher les mots clés
                    const rowStr = rows[i].map(c => String(c).toLowerCase().trim());
                    
                    // Est-ce que cette ligne contient un des mots clés ?
                    const match = keywords.some(k => rowStr.some(cell => cell.includes(k)));
                    
                    if (match) {
                        console.log(`Trouvé dans feuille "${sheetName}" à la ligne ${i+1}`);
                        // On retourne les données en coupant tout ce qui est avant l'en-tête
                        return rows.slice(i);
                    }
                }
            }
            
            // Fallback : Si on ne trouve rien, on prend la première feuille telle quelle
            console.warn("Aucun en-tête détecté, utilisation de la première feuille brute.");
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            return XLSX.utils.sheet_to_json(firstSheet, {header: 1});
        }

        // Gérer l'affichage du nom de fichier et lecture immédiate
        function handleFile(input, statusId) {
            const status = document.getElementById(statusId);
            if (input.files && input.files[0]) {
                const file = input.files[0];
                status.textContent = file.name;
                status.classList.add('text-blue-600', 'font-bold');
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        
                        // Mots-clés pour identifier les colonnes
                        let keywords = [];
                        if (statusId === 'refStatus') {
                            keywords = ["numéro de série", "numero de serie", "serie", "serial"];
                        } else {
                            keywords = ["commentaires", "message", "comment"];
                        }

                        // Recherche intelligente
                        const cleanData = findBestData(workbook, keywords);
                        
                        if (statusId === 'refStatus') dataRef = cleanData;
                        else dataTarget = cleanData;

                    } catch (err) {
                        console.error("Erreur lecture fichier:", err);
                        showError("Erreur lors de la lecture du fichier " + file.name);
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }

        // Fonction principale de traitement
        function processFiles() {
            const msgDiv = document.getElementById('statusMessage');
            msgDiv.className = "hidden mb-6 p-4 rounded-lg"; // Reset

            if (!dataRef || !dataTarget) {
                showError("Veuillez charger les deux fichiers avant de continuer.");
                return;
            }

            try {
                // 1. Convertir TOTAL GERE en un dictionnaire pour recherche rapide
                const headersRef = dataRef[0].map(h => String(h).trim().toLowerCase());
                
                // Index basés sur les noms
                const idxSerieRef = headersRef.findIndex(h => h.includes("numéro de série") || h.includes("serie") || h.includes("serial"));
                const idxModele = headersRef.findIndex(h => h.includes("modèle") || h.includes("modele"));
                const idxMono = headersRef.findIndex(h => h.includes("total mono") || h.includes("compteur noir"));
                const idxCouleur = headersRef.findIndex(h => h.includes("total couleur"));

                if (idxSerieRef === -1) {
                    throw new Error("Colonne 'Numéro de série' introuvable dans le fichier de Référence (Total Géré). Vérifiez les en-têtes.");
                }

                // Création de la Map: Serie -> {Modele, Mono, Couleur}
                const refMap = new Map();
                for (let i = 1; i < dataRef.length; i++) {
                    const row = dataRef[i];
                    if (!row[idxSerieRef]) continue;
                    
                    // Nettoyage série (Majuscule, sans espace)
                    const serieClean = String(row[idxSerieRef]).trim().toUpperCase();
                    
                    refMap.set(serieClean, {
                        modele: idxModele !== -1 ? row[idxModele] : "N/A",
                        mono: idxMono !== -1 ? row[idxMono] : 0,
                        couleur: idxCouleur !== -1 ? row[idxCouleur] : 0
                    });
                }

                // 2. Traiter MACHINE SANS RC
                const headersTarget = dataTarget[0].map(h => String(h).trim().toLowerCase());
                const idxComment = headersTarget.findIndex(h => h.includes("commentaires") || h.includes("message"));
                const idxClient = headersTarget.findIndex(h => h.includes("client"));

                if (idxComment === -1) {
                    throw new Error("Colonne 'Commentaires' introuvable dans le fichier 2 (Machine sans RC). Vérifiez les en-têtes.");
                }

                const processedRows = [];
                
                // En-têtes du fichier final
                processedRows.push(["Client", "Série Extraite", "Modèle", "Total Mono", "Total Couleur"]);

                let filteredCount = 0; // Compteur pour les 0/0
                let duplicatesCount = 0; // Compteur pour les doublons
                const seenSerials = new Set(); // Set pour suivre les numéros de série déjà ajoutés

                for (let i = 1; i < dataTarget.length; i++) {
                    const row = dataTarget[i];
                    // Skip empty rows
                    if (!row || row.length === 0) continue;

                    const comment = row[idxComment] ? String(row[idxComment]) : "";
                    const client = idxClient !== -1 ? row[idxClient] : "";

                    // Extraction Regex JS
                    let serieExtraite = "Non trouvé";
                    const match = comment.match(/du bien "([^"]+)"/i);
                    
                    if (match && match[1]) {
                        let contenu = match[1];
                        if (contenu.includes("/")) {
                            contenu = contenu.split("/").pop();
                        }
                        serieExtraite = contenu.trim().toUpperCase();
                    }

                    // RechercheV
                    let info = { modele: "Non trouvé dans F1", mono: 0, couleur: 0 };
                    if (serieExtraite !== "Non trouvé" && refMap.has(serieExtraite)) {
                        info = refMap.get(serieExtraite);
                    }

                    // --- 1. FILTRE COMPTEURS À ZÉRO ---
                    const valMono = parseFloat(info.mono) || 0;
                    const valCouleur = parseFloat(info.couleur) || 0;

                    if (valMono === 0 && valCouleur === 0) {
                        filteredCount++;
                        continue; // On saute cette ligne
                    }

                    // --- 2. FILTRE DOUBLONS ---
                    // Si on a un vrai numéro de série et qu'on l'a déjà vu, on saute
                    if (serieExtraite !== "Non trouvé") {
                        if (seenSerials.has(serieExtraite)) {
                            duplicatesCount++;
                            continue; // On saute ce doublon
                        }
                        // Sinon on l'ajoute à la liste des vus
                        seenSerials.add(serieExtraite);
                    }

                    // Si tout est bon, on ajoute la ligne
                    processedRows.push([
                        client,
                        serieExtraite,
                        info.modele,
                        valMono,
                        valCouleur
                    ]);
                }

                finalData = processedRows;
                showSuccess(processedRows.length - 1, filteredCount, duplicatesCount);
                renderPreview(processedRows);

            } catch (e) {
                showError("Erreur lors du traitement : " + e.message);
                console.error(e);
            }
        }

        function renderPreview(rows) {
            const tbody = document.getElementById('previewBody');
            tbody.innerHTML = "";
            // Afficher max 5 lignes
            const max = Math.min(rows.length, 6); // 1 header + 5 data
            
            if (rows.length <= 1) {
                tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-slate-400 italic">Aucune donnée trouvée après filtrage.</td></tr>`;
                return;
            }

            for (let i = 1; i < max; i++) {
                const row = rows[i];
                const tr = document.createElement('tr');
                tr.className = "bg-white border-b hover:bg-slate-50";
                
                // Client, Série, Modèle, Mono, Couleur (Indices 0, 1, 2, 3, 4)
                // Le modèle reçoit une couleur spéciale si trouvé
                const found = row[2] !== "Non trouvé dans F1";
                const modelClass = found ? "text-green-600 font-medium" : "text-red-400 italic";

                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-slate-900 whitespace-nowrap">${row[0] || ''}</td>
                    <td class="px-6 py-4 text-blue-600 bg-blue-50 rounded-lg">${row[1]}</td>
                    <td class="px-6 py-4 ${modelClass}">${row[2]}</td>
                    <td class="px-6 py-4 font-mono">${row[3]}</td>
                    <td class="px-6 py-4 font-mono">${row[4]}</td>
                `;
                tbody.appendChild(tr);
            }
            document.getElementById('resultSection').classList.remove('hidden');
        }

        function downloadExcel() {
            if (!finalData) return;
            
            // Création Workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(finalData);
            
            // Auto-fit columns width (basic)
            const wscols = [
                {wch: 30}, // Client
                {wch: 20}, // Serie
                {wch: 25}, // Modele
                {wch: 15}, // Mono
                {wch: 15}, // Couleur
            ];
            ws['!cols'] = wscols;

            XLSX.utils.book_append_sheet(wb, ws, "Resultat");
            XLSX.writeFile(wb, "RESULTAT_COMPARAISON.xlsx");
        }

        function showError(msg) {
            const el = document.getElementById('statusMessage');
            el.className = "mb-6 p-4 rounded-lg bg-red-100 text-red-700 border border-red-200 flex items-center gap-2";
            el.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> ${msg}`;
            el.classList.remove('hidden');
        }

        function showSuccess(count, filtered, duplicates) {
            const el = document.getElementById('statusMessage');
            // On le cache car le tableau de résultat s'affiche, mais on met à jour le compteur
            document.getElementById('resultCount').innerHTML = `<b>${count}</b> machines conservées`;
            
            document.getElementById('resultDetails').innerHTML = `
                <span><i class="fa-solid fa-filter"></i> <b>${filtered}</b> masquées (compteurs 0)</span>
                <span><i class="fa-solid fa-clone"></i> <b>${duplicates}</b> doublons supprimés</span>
            `;
        }

    </script>
</body>
</html>
